#!/usr/bin/python3

import sys, os
from functools import partial

from PyQt5.QtWidgets import QApplication, QMainWindow, QMessageBox
from PyQt5 import uic, QtWidgets
from PyQt5.QtSql import QSqlDatabase


from libgcode import face
from libgcode import grid
from libgcode import cancycle
from libgcode import pocket
from libgcode import drillchart
from libgcode import millchart
from libgcode import tap
from libgcode import thread
from libgcode import gcode
from libgcode import utilities
from libgcode import develop
from libgcode import helptext
from libgcode.help import Ui_Dialog as helpDialog


if os.path.split(sys.argv[0])[0] == '/usr/bin':
	GUI_PATH = '/usr/lib/libgcode'
	print('Installed')
	DEVEL = False

if os.path.split(sys.argv[0])[0] == '.':
	GUI_PATH = os.path.split(os.path.realpath(sys.argv[0]))[0]
	print('In Development')
	DEVEL = True

class main(QMainWindow):
	def __init__(self):
		super().__init__()
		uic.loadUi(os.path.join(GUI_PATH, 'gcode.ui'), self)
		self.setGeometry(50, 50, 500, 300)
		self.setWindowTitle("G code Generator")
		self.setupConnections()
		utilities.getSettings(self)
		self.helpInfo = helptext.descriptions
		#db = QSqlDatabase.addDatabase('QSQLITE')
		#db.setDatabaseName(GUI_PATH + 'threads.db')
		#if db.open():
		#	print("Connection success !")
		#else:
		#	print("Connection failed !\n{}".format(db.lastError().text()))
		self.devel = False
		if DEVEL:
			self.devel = True
			self.canToolLE.setText('1')
			self.canRetractLE.setText('0.250')
			self.canRpmLE.setText('675')
			self.canZdepthLE.setText('-1.250')
			self.canFeedLE.setText('5')
			self.canCoordPTE.appendPlainText('X1.0 Y-1.0')
			self.canCoordPTE.appendPlainText('X2.0 Y-1.0')
			self.canCoordPTE.appendPlainText('X3.0 Y-1.0')
			#develop.face(self)
			#face.generate(self)
			#develop.pocket(self)
			#pocket.generate(self)
		self.show()


	#def mousePressEvent(self, e):
	#	self.selectAll()      

	def setupConnections(self):
		self.saveSettingsPB.clicked.connect(partial(utilities.saveSettings, self))

		self.faceGeneratePB.clicked.connect(partial(face.generate, self))
		self.faceCopyPB.clicked.connect(partial(face.copy, self))
		self.faceSavePB.clicked.connect(partial(face.save, self))
		self.faceSendPB.clicked.connect(partial(face.send, self))

		self.pocketGeneratePB.clicked.connect(partial(pocket.generate, self))
		self.pocketCopyPB.clicked.connect(partial(pocket.copy, self))
		self.pocketSavePB.clicked.connect(partial(pocket.save, self))
		self.pocketSendPB.clicked.connect(partial(pocket.send, self))


		self.canCycleBG.buttonClicked.connect(partial(cancycle.update, self))
		self.canSelectPB.clicked.connect(partial(cancycle.get, self))
		self.canGeneratePB.clicked.connect(partial(cancycle.gcode, self))
		self.canXcoordLE.returnPressed.connect(partial(cancycle.xcoord, self))
		self.canYcoordLE.returnPressed.connect(partial(cancycle.ycoord, self))
		self.canCopyPB.clicked.connect(partial(cancycle.copy, self))
		self.canRemovePB.clicked.connect(partial(cancycle.delete, self))
		self.canSendPB.clicked.connect(partial(cancycle.send, self))

		self.drillUnitsBG.buttonClicked.connect(partial(drillchart.update, self))
		self.drillMaterialBG.buttonClicked.connect(partial(drillchart.update, self))
		self.drillDepthBG.buttonClicked.connect(partial(drillchart.populate, self))
		self.drillSfmSB.valueChanged.connect(partial(drillchart.populate, self))
		self.drilliprSB.valueChanged.connect(partial(drillchart.populate, self))
		self.drillMachineCB.currentIndexChanged.connect(partial(drillchart.update, self))

		self.millUnitsBG.buttonClicked.connect(partial(millchart.update, self))
		self.millMaterialBG.buttonClicked.connect(partial(millchart.update, self))
		self.millSfmSB.valueChanged.connect(partial(millchart.populate, self))
		self.millToothsSB.valueChanged.connect(partial(millchart.populate, self))
		self.millChipLoadFactorDSB.valueChanged.connect(partial(millchart.populate, self))
		self.millMachineCB.currentIndexChanged.connect(partial(millchart.update, self))

		#self.drillSelectPB.pressed.connect(partial(hole.drill, self))

		self.gcodeCopyPB.clicked.connect(partial(gcode.copy, self))
		self.gcodeRemovePB.clicked.connect(partial(gcode.delete, self))
		self.gcodeAddM2PB.clicked.connect(partial(gcode.addM2, self))


		self.actionTabHelp.triggered.connect(self.help)

	def setupVariables(self):
		self.s1018 = []
		self.sa2d2 = []
		self.cast = []
		self.aluminum = []
		self.brass = []

	def errorMsgOk(self, text, title=None):
		msgBox = QMessageBox()
		msgBox.setIcon(QMessageBox.Warning)
		msgBox.setWindowTitle(title)
		msgBox.setText(text)
		msgBox.setStandardButtons(QMessageBox.Ok)
		returnValue = msgBox.exec()

	def help(self, index = False):
		dialog = QtWidgets.QDialog()
		dialog.ui = helpDialog()
		dialog.ui.setupUi(dialog)
		if index:
			dialog.ui.helpPTE.setPlainText(self.helpInfo(index))
		else:
			index = self.tabWidget.currentIndex()
			if index == 3:
				print(self.canCycleBG.checkedButton())
				if self.canCycleBG.checkedButton() is None:
					print('here')
					dialog.ui.helpPTE.setPlainText(self.helpInfo(30))
				else:
					tab = {'G81':31, 'G82':32, 'G83':33, 'G84':34, 'G85':35,
						'G86':36, 'G89':39}
					cycle = self.canCycleBG.checkedButton().text()
					dialog.ui.helpPTE.setPlainText(self.helpInfo(tab[cycle]))
			else:
				dialog.ui.helpPTE.setPlainText(self.helpInfo(self.tabWidget.currentIndex()))
		dialog.exec_()


if __name__ == '__main__':
	app = QApplication(sys.argv)
	gui = main()
	sys.exit(app.exec_())
